model Authentication {
  code       String   @db.Char(6)
  retryTime  Int      @default(0) @map("retry_time") @db.SmallInt
  type       AuthType
  lastSentAt DateTime @map("last_sent_at") @db.Timestamptz
  expiresAt  DateTime @map("expires_at") @db.Timestamptz

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String @db.Uuid

  @@unique([type, userId], name: "id")
  @@map("authentication")
}

model MfaSetup {
  id        String   @id @default(uuid()) @db.Uuid
  type      MfaType
  secret    String?  @db.VarChar(255)
  phone     String?  @db.VarChar(20)
  email     String?  @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  user   UserSecurity @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
  userId String       @db.Uuid

  @@unique([userId, type], name: "userMfaType", map: "user_mfa_type")
  @@map("mfa_setup")
}

model MfaBackupCode {
  id        String    @id @default(uuid()) @db.Uuid
  code      String    @db.VarChar(10) // 8-10 character backup code
  isUsed    Boolean   @default(false) @map("is_used")
  usedAt    DateTime? @map("used_at") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz

  user   UserSecurity @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
  userId String       @db.Uuid

  @@unique([userId, code], name: "userBackupCode", map: "user_backup_code")
  @@map("mfa_backup_code")
}

model LoginSession {
  id           String   @id @default(uuid()) @db.Uuid
  sessionId    String   @unique @map("session_id") @db.VarChar(255)
  refreshToken String?  @unique @map("refresh_token") @db.VarChar(512)
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  userAgent    String?  @map("user_agent") @db.Text
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  lastUsedAt   DateTime @default(now()) @updatedAt @map("last_used_at") @db.Timestamptz

  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("login_session")
}

enum AuthType {
  VERIFY_EMAIL
  MFA_EMAIL
  MFA_SMS
  MFA_TOTP
  PASSWORD_RESET

  @@map("auth_type")
}

enum MfaType {
  TOTP
  SMS
  EMAIL

  @@map("mfa_type")
}
